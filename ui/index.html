<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>SonicPi Blockly</title>
	<script src="js/blockly_compressed.js"></script>
	<script src="js/blockly_patches.js"></script>
	<script src="js/messages.js"></script>
	<script src="js/en.js"></script>
	<script src="js/blocks_compressed.js"></script>
	<script src="js/sonicpi.js"></script>
	<script src="js/sonicpi_blocks.js"></script>
	<script src="js/sonicpi_generators.js"></script>
	<style>
		/* TODO: CHANGE ME */
		.blocklySelected > .blocklyPath { stroke: #111 !important; stroke-width: 1pt !important; }

		body {
			background-color: #fff;
			font-family: Helvetica, Arial, sans-serif;
		}
		h1 {
			font-weight: normal;
			font-size: 140%;
		}

		button {
			-webkit-appearance: none;
			outline: none;

			background: #1abc9c;
			color: #fff;

			padding: 10px;
			border-radius: 3px;
			border: none;
			margin: 3px;
			cursor: pointer;
		}

		#conn-status {
			color: #fff; 
			background: #e74c3c; 
			display: inline-block; 
			padding: 10px; 
			border-radius: 3px;
		}
	</style>
</head>
<body>
  <h1>SonicPi Blockly</h1>
  <h4><div id="conn-status">Disconnected</div></h4>
  <p>
    <button onclick="runCode()">▶ Run</button>
    <button onclick="stopAll()">■ Stop</button>
    <button onclick="updateCode()">[DEBUG] Show Code</button>
  </p>

  <div id="blocklyDiv" style="height: 480px; width: 600px; display:inline-block"></div>

    <xml id="toolbox" style="display: none">
        <category name="Math">
            <block type="math_number"></block>
            <block type="math_arithmetic"></block>
        </category>
        <category name="Sound">
            <block type="sample"></block>
            <block type="play_basic"></block>
            <block type="play_advanced"></block>
            <block type="note"></block>
            <block type="midi_note"></block>
            <block type="duration"></block>
            <block type="sleep"></block>
        </category>
        <category name="Flow">
            <block type="live_loop"></block>
            <block type="duration"></block>
            <block type="in_thread"></block>
            <block type="controls_repeat_ext"></block>
        </category>
        <category name="Feel">
            <block type="bpm"></block>
            <block type="synth"></block>
            <block type="fx"></block>
        </category>
        <category name="Variables" colour="330" custom="VARIABLE"></category>
        <category name="Functions" colour="290" custom="PROCEDURE"></category>
    </xml>

  <xml id="startBlocks" style="display: none">
    <block type="play_basic" x="20" y="20">
    </block>
  </xml>

  <textarea readonly id="spi-code" style="display: inline-block; resize: none; width: 50%; height: 500px"></textarea>

  <script>
    var workspace = Blockly.inject('blocklyDiv',
        {media: 'media/',
         toolbox: document.getElementById('toolbox')});
    Blockly.Xml.domToWorkspace(document.getElementById('startBlocks'),
                               workspace);


    ws = null;

    function setupWebsocket() {
      ws = new WebSocket("ws://127.0.0.1:4001/");
      var el = document.getElementById("conn-status");
      el.textContent = "Connecting...";
      el.style.backgroundColor = "#f1c40f";


      ws.onopen = function() {
        console.log("websocket connected");
        var el = document.getElementById("conn-status");
        el.textContent = "Connected";
        el.style.backgroundColor = "#2ecc71";
      }

      ws.onclose = function() {
        console.log("websocket disconnected");
        var el = document.getElementById("conn-status");
        el.textContent = "Disconnected";
        el.style.backgroundColor = "#e74c3c";

        setTimeout(setupWebsocket, 1000);
      }
    }

    setupWebsocket();

    function stopAll() {
      ws.send(JSON.stringify({type: "stop-all"}));
    }

    function runCode() {
      var code = Blockly.SonicPi.workspaceToCode(workspace);
      var payload = JSON.stringify({type: "run", code: code});
      ws.send(payload);
      console.log(payload);
    }

    function updateCode() {
      var el = document.getElementById("spi-code");
      // Generate JavaScript code and display it.
      Blockly.SonicPi.INFINITE_LOOP_TRAP = null;
      var code = Blockly.SonicPi.workspaceToCode(workspace);
      console.log(code);
      console.log(el);
      el.value = code;
    }


  </script>

</body>
</html>
