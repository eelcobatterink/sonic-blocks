<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>SonicPi Blockly</title>
	<script src="js/blockly_compressed.js"></script>
	<script src="js/blockly_patches.js"></script>
	<script src="js/messages.js"></script>
	<script src="js/en.js"></script>
	<script src="js/blocks_compressed.js"></script>
	<script src="js/sonicpi.js"></script>
	<script src="js/sonicpi_blocks.js"></script>
	<script src="js/sonicpi_generators.js"></script>
	<script>
		function loadXMLDoc(dname){
			if (window.XMLHttpRequest){
				xhttp=new XMLHttpRequest();
			} else {
				xhttp=new ActiveXObject("Microsoft.XMLDOM");
			}
			
			xhttp.open("GET", dname, false);
			xhttp.send();
			return xhttp.responseXML;
		}
	</script>
				
				
	<style>
		/* TODO: CHANGE ME */
		.blocklySelected > .blocklyPath { stroke: #111 !important; stroke-width: 1pt !important; }

		body {
			background-color: #fff;
			font-family: Helvetica, Arial, sans-serif;
		}
		h1 {
			font-weight: normal;
			font-size: 140%;
		}

		button {
			-webkit-appearance: none;
			outline: none;

			background: #1abc9c;
			color: #fff;

			padding: 10px;
			border-radius: 3px;
			border: none;
			margin: 3px;
			cursor: pointer;
		}

		#conn-status {
			color: #fff; 
			background: #e74c3c; 
			display: inline-block; 
			padding: 10px; 
			border-radius: 3px;
		}
	</style>
</head>
<body>
  <h1>SonicPi Blockly</h1>
  <h4><div id="conn-status">Disconnected</div></h4>
  <p>
    <button onclick="runCode()">▶ Run</button>
    <button onclick="stopAll()">■ Stop</button>
    <button class="dev" onclick="updateCode()">[DEBUG] Show Code</button>
    <button class="dev" onclick="displayXml()">[DEBUG] Show XML</button>
  </p>

  <div id="blocklyDiv" style="height: 480px; width: 600px; display:inline-block"></div>
	
	<!--<script>
		xmlDoc=loadXMLDoc("./toolbox.xml");
		document.write(xmlDoc.getElementById("toolbox"));
	</script>-->
    <xml id="toolbox" style="display: none">
        <category name="Math">
            <block type="math_number"></block>
            <block type="math_arithmetic"></block>
        </category>
        <category name="Sound">
			<category name="Basic">
				<block type="play_basic"></block>
				<block type="note"></block>
				<block type="midi_note"></block>
				<block type="sleep"></block>
				<block type="duration"></block>
				<category name="Samples">
					<block type="ambient_sample"></block>	
					<block type="bass_drum_sample"></block>	
					<block type="bass_sounds_sample"></block>	
					<block type="drum_sounds_sample"></block>
					<block type="electric_sounds_sample"></block>
				</category>
			</category>
			<category name="Advanced">
				<block type="play_advanced"></block>
				<block type="sample_custom"></block>
				<block type="fx_option"></block>
				<block type="puts"></block>
				<block type="scale"></block>
			</category>
        </category>
        <category name="Loops">
            <block type="live_loop"></block>
            <block type="in_thread"></block>
            <block type="controls_repeat_ext"></block>
        </category>
        <category name="Feel">
            <block type="bpm"></block>
            <block type="synth"></block>
            <block type="fx"></block>
        </category>
        <category name="Variables" colour="100" custom="VARIABLE"></category>
        <category name="Functions" colour="60" custom="PROCEDURE"></category>
		<category name="Examples">
			<category name="Drum Rhythms">
				
			<block type="procedures_defnoreturn" id="rBzf$@ka@oS5sPyOP(q[" x="46" y="-75">
				<field name="NAME">Drum 1</field>
				<comment pinned="false" h="80" w="160">Describe this function...</comment>
				<statement name="STACK">
				  <block type="in_thread" id="-6E:VE9;t_L!i?V?xC{)">
					<statement name="DO">
					  <block type="controls_repeat_ext" id="U~n1A:v{9=?yn+@q^eW2">
						<value name="TIMES">
						  <block type="math_number" id="ZMTCPB[:%#QH^iM#@8f#">
							<field name="NUM">12</field>
						  </block>
						</value>
						<statement name="DO">
						  <block type="bass_drum_sample" id="4q+pxozhQOn;LNZOw69y">
							<field name="SAMPLE">bd_haus</field>
							<next>
							  <block type="sleep" id="Jt?{#p45.t(aZn$U-j+B">
								<value name="SLEEP_PERIOD">
								  <block type="duration" id="VMO[zJ!fno^Y_xG#X=tB">
									<field name="DURATION">2</field>
									<field name="NOTE_BASE">1</field>
									<field name="IS_DOTTED">FALSE</field>
								  </block>
								</value>
							  </block>
							</next>
						  </block>
						</statement>
					  </block>
					</statement>
				  </block>
				</statement>
			  </block>
			
			<block type="procedures_defnoreturn" id=":)`r!wd=97g$G(.R-]_4" x="38" y="-28">
				<field name="NAME">Drum 2</field>
				<comment pinned="false" h="80" w="160">Describe this function...</comment>
				<statement name="STACK">
				  <block type="in_thread" id="f~3f3er={]7.k3rwPFZ0">
					<statement name="DO">
					  <block type="controls_repeat_ext" id="*QdA$d3Ph+m|7WjJkT-W">
						<value name="TIMES">
						  <block type="math_number" id="Oe-R$Fuw~[4K/Q6t_9c(">
							<field name="NUM">4</field>
						  </block>
						</value>
						<statement name="DO">
						  <block type="controls_repeat_ext" id="Z-6Yz`UJe|^?9tn]YNlS">
							<value name="TIMES">
							  <block type="math_number" id="8Z/aft;=phHH!c9)jNga">
								<field name="NUM">2</field>
							  </block>
							</value>
							<statement name="DO">
							  <block type="bass_drum_sample" id="d,=u`Ifa|Y-N,Hd8k;UJ">
								<field name="SAMPLE">bd_haus</field>
								<next>
								  <block type="sleep" id="lR7=g72ZHSBw_bKZbw.2">
									<value name="SLEEP_PERIOD">
									  <block type="duration" id="GUT}[$c8c[`wWHu!3n_w">
										<field name="DURATION">1</field>
										<field name="NOTE_BASE">1</field>
										<field name="IS_DOTTED">FALSE</field>
									  </block>
									</value>
								  </block>
								</next>
							  </block>
							</statement>
							<next>
							  <block type="controls_repeat_ext" id="!.rn1gIVx0E`prf##!/+">
								<value name="TIMES">
								  <block type="math_number" id="Ydj8;q,uNY$mYcl]u{/D">
									<field name="NUM">3</field>
								  </block>
								</value>
								<statement name="DO">
								  <block type="bass_drum_sample" id="D]mz}ktZ5K-}Rm0RO=AG">
									<field name="SAMPLE">bd_haus</field>
									<next>
									  <block type="sleep" id="I%Z.Icc1|tPnIfSYqF}=">
										<value name="SLEEP_PERIOD">
										  <block type="duration" id="=KRl]Jl@q]hZ=gT6EhEu">
											<field name="DURATION">2</field>
											<field name="NOTE_BASE">1</field>
											<field name="IS_DOTTED">FALSE</field>
										  </block>
										</value>
									  </block>
									</next>
								  </block>
								</statement>
							  </block>
							</next>
						  </block>
						</statement>
					  </block>
					</statement>
				  </block>
				</statement>
			  </block>
			</category>
		  
	  </category>
    </xml>
	
  <xml id="startBlocks" style="display: none">
    <block type="play_basic" x="20" y="20">
    </block>
  </xml>

  <textarea class="dev" readonly id="spi-code" style="display: inline-block; resize: none; width: 50%; height: 500px"></textarea>
  <textarea class="dev" readonly id="xml-code" style="display: inline-block; resize: none; width: 50%; height: 500px"></textarea>

  <script>
    var workspace = Blockly.inject('blocklyDiv',
        {media: 'media/',
         toolbox: document.getElementById('toolbox')});
    Blockly.Xml.domToWorkspace(document.getElementById('startBlocks'), workspace);


		window.isDev = false;
		if(require("electron").remote.process.argv.indexOf("--dev") != -1) {
			window.isDev = true;
		}

		// Do some cleanup based on whether we're dev or not
		if(!isDev) {
			// Hide DEBUG buttons
			const devElements = document.getElementsByClassName("dev");
			for(let i = devElements.length; i--;) {
				devElements[i].style.display = "none";
			}
		}

    ws = null;

    function setupWebsocket() {
      ws = new WebSocket("ws://127.0.0.1:4001/");
      var el = document.getElementById("conn-status");
      el.textContent = "Connecting...";
      el.style.backgroundColor = "#f1c40f";


      ws.onopen = function() {
        console.log("websocket connected");
        var el = document.getElementById("conn-status");
        el.textContent = "Connected";
        el.style.backgroundColor = "#2ecc71";
      }

      ws.onclose = function() {
        console.log("websocket disconnected");
        var el = document.getElementById("conn-status");
        el.textContent = "Disconnected";
        el.style.backgroundColor = "#e74c3c";

        setTimeout(setupWebsocket, 1000);
      }
    }

    setupWebsocket();

    function stopAll() {
      ws.send(JSON.stringify({type: "stop-all"}));
    }

    function runCode() {
      var code = Blockly.SonicPi.workspaceToCode(workspace);
      var payload = JSON.stringify({type: "run", code: code});
      ws.send(payload);
      console.log(payload);
    }

    function updateCode() {
      var el = document.getElementById("spi-code");
      // Generate JavaScript code and display it.
      Blockly.SonicPi.INFINITE_LOOP_TRAP = null;
      var code = Blockly.SonicPi.workspaceToCode(workspace);
      el.value = code;
    }
	
    function displayXml() {
      var e1 = document.getElementById("xml-code");
      var xmlDom = Blockly.Xml.workspaceToDom(workspace);
      var xmlText = Blockly.Xml.domToPrettyText(xmlDom);
      e1.value = xmlText;
    }


  </script>

</body>
</html>
